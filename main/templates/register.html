{% extends 'base.html' %}

{% block meta %}
<title>Register - GoalStrike</title>
{% endblock meta %}

{% block content %}
<!-- Toast Container -->
<div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

<div class="bg-gray-50 min-h-screen flex items-center justify-center p-8">
  <div class="max-w-md w-full">
    <div class="card-style p-8 form-style">
      <div class="text-center mb-8">
        <h2 class="text-2xl mb-2">Join Us</h2>
        <p>Create your GoalStrike account</p>
      </div>

      <!-- Error Display -->
      <div id="error-container" class="hidden mb-6"></div>

      <form id="registerForm" class="space-y-5">
        {% csrf_token %}
        
        <div>
          <label for="username" class="block mb-2 text-sm font-medium">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            required
            placeholder="Choose a username"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          <p class="text-xs text-gray-500 mt-1">150 characters or fewer. Letters, digits and @/./+/-/_ only.</p>
        </div>

        <div>
          <label for="password1" class="block mb-2 text-sm font-medium">Password</label>
          <input 
            id="password1" 
            name="password1" 
            type="password" 
            required
            placeholder="Create a strong password"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          <p class="text-xs text-gray-500 mt-1">Your password must contain at least 8 characters.</p>
        </div>

        <div>
          <label for="password2" class="block mb-2 text-sm font-medium">Confirm Password</label>
          <input 
            id="password2" 
            name="password2" 
            type="password" 
            required
            placeholder="Re-enter your password"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>

        <button type="submit" id="submitBtn" class="btn-primary w-full flex items-center justify-center">
          <span id="btnText">Create Account</span>
          <svg id="loadingSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>

      <div class="mt-6 text-center">
        <p class="text-sm">
          Already have an account? 
          <a href="{% url 'main:login' %}" class="text-highlight hover:underline">Sign In</a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// Toast Notification Function
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    
    const iconColors = {
        success: 'text-green-500',
        error: 'text-red-500',
        info: 'text-blue-500',
        warning: 'text-yellow-500'
    };
    
    const icons = {
        success: '<path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/>',
        error: '<path d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.707-11.707a1 1 0 0 0-1.414-1.414L10 8.586 7.707 6.293a1 1 0 0 0-1.414 1.414L8.586 10l-2.293 2.293a1 1 0 1 0 1.414 1.414L10 11.414l2.293 2.293a1 1 0 1 0 1.414-1.414L11.414 10l2.293-2.293Z"/>',
        info: '<path d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm1-11a1 1 0 1 0-2 0v4a1 1 0 1 0 2 0V7Zm-1 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/>',
        warning: '<path d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm1-11a1 1 0 1 0-2 0v4a1 1 0 1 0 2 0V7Zm-1 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/>'
    };
    
    const toast = document.createElement('div');
    toast.className = 'flex items-center w-full max-w-xs p-4 space-x-4 text-gray-500 bg-white divide-x divide-gray-200 rounded-lg shadow';
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    toast.style.transition = 'all 0.3s ease-out';
    
    toast.innerHTML = `
        <div class="${iconColors[type] || iconColors.info}">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                ${icons[type] || icons.info}
            </svg>
        </div>
        <div class="ps-4 text-sm font-normal">${message}</div>
        <button type="button" class="ms-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
        </button>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Show error in form
function showError(errors) {
    const errorContainer = document.getElementById('error-container');
    let errorHTML = '<div class="bg-red-50 border border-red-200 rounded-md p-4">';
    
    if (typeof errors === 'string') {
        errorHTML += `<p class="text-red-700 text-sm">${errors}</p>`;
    } else if (typeof errors === 'object') {
        errorHTML += '<ul class="list-disc list-inside space-y-1">';
        for (const [field, messages] of Object.entries(errors)) {
            if (Array.isArray(messages)) {
                messages.forEach(msg => {
                    errorHTML += `<li class="text-red-700 text-sm"><strong>${field}:</strong> ${msg}</li>`;
                });
            } else {
                errorHTML += `<li class="text-red-700 text-sm"><strong>${field}:</strong> ${messages}</li>`;
            }
        }
        errorHTML += '</ul>';
    }
    
    errorHTML += '</div>';
    errorContainer.innerHTML = errorHTML;
    errorContainer.classList.remove('hidden');
}

// Hide error
function hideError() {
    const errorContainer = document.getElementById('error-container');
    errorContainer.classList.add('hidden');
}

// Handle Register Form Submit
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    // Get form data
    const formData = new FormData(this);
    
    // Disable button and show loading
    submitBtn.disabled = true;
    btnText.textContent = 'Creating Account...';
    loadingSpinner.classList.remove('hidden');
    hideError();
    
    try {
        const response = await fetch("{% url 'main:register' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Account created successfully! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = data.redirect || "{% url 'main:show_main' %}";
            }, 1500);
        } else {
            if (data.errors) {
                showError(data.errors);
            } else {
                showError(data.message || 'Registration failed. Please try again.');
            }
            submitBtn.disabled = false;
            btnText.textContent = 'Create Account';
            loadingSpinner.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error:', error);
        showError('An error occurred. Please try again.');
        submitBtn.disabled = false;
        btnText.textContent = 'Create Account';
        loadingSpinner.classList.add('hidden');
    }
});
</script>

{% endblock content %}